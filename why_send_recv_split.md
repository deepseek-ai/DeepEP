# DeepEP ä¸ºä»€ä¹ˆéœ€è¦ Send/Recv åˆ†ç¦»è®¾è®¡ï¼Ÿ

## æ ¸å¿ƒé—®é¢˜

åœ¨ DeepEP çš„ dispatch kernel ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸€ä¸ªç‰¹æ®Šçš„è®¾è®¡ï¼š

```cpp
const bool is_sender = sm_id % 2 == 0;  // å¶æ•° SM blocks ä¸º sender
                                        // å¥‡æ•° SM blocks ä¸º receiver
```

**ä¸ºä»€ä¹ˆè¦åˆ†ç¦» send å’Œ recvï¼Ÿä¸ºä»€ä¹ˆä¸èƒ½è®©åŒä¸€ä¸ª SM æ—¢å‘é€åˆæ¥æ”¶ï¼Ÿ**

---

## å¿«é€Ÿå›ç­”

**æ ¸å¿ƒåŸå› **ï¼šå®ç°**å…¨åŒå·¥ã€æ— æ­»é”çš„æµæ°´çº¿é€šä¿¡**ã€‚

```
Send å’Œ Recv åˆ†ç¦» = ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼åœ¨ GPU ä¸Šçš„å®ç°

ç›®æ ‡ï¼š
1. å…è®¸å‘é€å’Œæ¥æ”¶åŒæ—¶è¿›è¡Œï¼ˆå…¨åŒå·¥ï¼‰
2. é¿å…æ­»é”ï¼ˆæ‰€æœ‰ GPU éƒ½åœ¨ç­‰å¾…å¯¹æ–¹ï¼‰
3. æœ€å¤§åŒ–å¸¦å®½åˆ©ç”¨ç‡
4. æ”¯æŒå¾ªç¯ç¼“å†²åŒºçš„å¹¶å‘è¯»å†™
```

---

## æ·±åº¦åˆ†æ

### 1. é¿å…æ­»é”ï¼ˆDeadlock Avoidanceï¼‰

#### é—®é¢˜åœºæ™¯ï¼šå¦‚æœæ²¡æœ‰åˆ†ç¦» send/recv

å‡è®¾æ‰€æœ‰ SM éƒ½å…ˆå‘é€ã€åæ¥æ”¶ï¼š

```mermaid
sequenceDiagram
    participant R0 as Rank 0 (All SMs)
    participant R1 as Rank 1 (All SMs)
    participant R2 as Rank 2 (All SMs)

    Note over R0,R2: Phase 1: æ‰€æœ‰ Rank éƒ½åœ¨å‘é€
    R0->>R1: å‘é€æ•°æ®ï¼ˆå†™å…¥ R1 çš„å¾ªç¯ç¼“å†²åŒºï¼‰
    R1->>R2: å‘é€æ•°æ®ï¼ˆå†™å…¥ R2 çš„å¾ªç¯ç¼“å†²åŒºï¼‰
    R2->>R0: å‘é€æ•°æ®ï¼ˆå†™å…¥ R0 çš„å¾ªç¯ç¼“å†²åŒºï¼‰

    Note over R0,R2: é—®é¢˜ï¼šè°æ¥æ¥æ”¶ï¼Ÿ
    Note over R0,R2: æ‰€æœ‰ Rank éƒ½åœ¨å‘é€ï¼Œæ²¡æœ‰äººæ¥æ”¶ï¼
    Note over R0,R2: å¾ªç¯ç¼“å†²åŒºæ»¡ â†’ æ­»é”ï¼

    rect rgb(255, 200, 200)
        Note over R0,R2: âŒ DEADLOCK âŒ
    end
```

**æ­»é”å‘ç”Ÿ**ï¼š
- Rank 0 æƒ³å‘é€åˆ° Rank 1ï¼Œä½† Rank 1 çš„ç¼“å†²åŒºæ»¡äº†ï¼ˆå› ä¸º Rank 1 åœ¨å‘é€ï¼Œæ²¡æœ‰æ¥æ”¶ï¼‰
- Rank 1 æƒ³å‘é€åˆ° Rank 2ï¼Œä½† Rank 2 çš„ç¼“å†²åŒºæ»¡äº†
- Rank 2 æƒ³å‘é€åˆ° Rank 0ï¼Œä½† Rank 0 çš„ç¼“å†²åŒºæ»¡äº†
- **å¾ªç¯ç­‰å¾… â†’ æ­»é”ï¼**

---

#### è§£å†³æ–¹æ¡ˆï¼šSend/Recv åˆ†ç¦»

```mermaid
sequenceDiagram
    participant S0 as Rank 0 Senders<br/>(å¶æ•° SMs)
    participant R0 as Rank 0 Receivers<br/>(å¥‡æ•° SMs)
    participant S1 as Rank 1 Senders
    participant R1 as Rank 1 Receivers

    par å¹¶è¡Œæ‰§è¡Œ
        S0->>R1: å†™å…¥ Rank 1 çš„ç¼“å†²åŒº
        S1->>R0: å†™å…¥ Rank 0 çš„ç¼“å†²åŒº
    and
        R0->>R0: ä»ç¼“å†²åŒºè¯»å–
        R1->>R1: ä»ç¼“å†²åŒºè¯»å–
    end

    Note over S0,R1: âœ… æ— æ­»é”ï¼š<br/>å§‹ç»ˆæœ‰ SM åœ¨å‘é€ï¼Œæœ‰ SM åœ¨æ¥æ”¶
```

**å…³é”®è®¾è®¡**ï¼š
- **Sender SMs**ï¼šä¸“æ³¨äºå‘é€æ•°æ®åˆ°å…¶ä»– ranks
- **Receiver SMs**ï¼šä¸“æ³¨äºä»ç¼“å†²åŒºè¯»å–æ•°æ®å¹¶å†™å…¥æœ€ç»ˆ buffer
- **åŒæ—¶è¿›è¡Œ**ï¼šå‘é€å’Œæ¥æ”¶åœ¨ä¸åŒçš„ SMs ä¸Šå¹¶è¡Œæ‰§è¡Œ

---

### 2. å…¨åŒå·¥é€šä¿¡ï¼ˆFull-Duplex Communicationï¼‰

#### ä»€ä¹ˆæ˜¯å…¨åŒå·¥ï¼Ÿ

```
åŠåŒå·¥ï¼ˆHalf-Duplexï¼‰ï¼š
  Time 0-10ms: Rank 0 â†’ Rank 1
  Time 10-20ms: Rank 1 â†’ Rank 0
  (è½®æµå‘é€ï¼Œæ€»æ—¶é—´ 20ms)

å…¨åŒå·¥ï¼ˆFull-Duplexï¼‰ï¼š
  Time 0-10ms: Rank 0 â‡„ Rank 1 (åŒæ—¶åŒå‘)
  (å¹¶å‘å‘é€ï¼Œæ€»æ—¶é—´ 10ms)
```

#### DeepEP çš„å…¨åŒå·¥å®ç°

```cpp
// Sender SMsï¼ˆå¶æ•° SM blocksï¼‰
if (is_sender) {
    // å‘é€æ•°æ®åˆ° responsible_rank
    nvshmem_int_put(channel_x_buffers, local_data, nelems, responsible_rank);
}

// Receiver SMsï¼ˆå¥‡æ•° SM blocksï¼‰
else {
    // ä» responsible_rank æ¥æ”¶æ•°æ®
    // ä»å¾ªç¯ç¼“å†²åŒºè¯»å– â†’ å†™å…¥æœ€ç»ˆ buffer
}
```

**ç¤ºä¾‹**ï¼šRank 0 å’Œ Rank 1 ä¹‹é—´çš„åŒå‘é€šä¿¡

```
Rank 0:
  SM 0, 2, 4, ... (Senders)  â†’ å‘é€åˆ° Rank 1
  SM 1, 3, 5, ... (Receivers) â† æ¥æ”¶æ¥è‡ª Rank 1

Rank 1:
  SM 0, 2, 4, ... (Senders)  â†’ å‘é€åˆ° Rank 0
  SM 1, 3, 5, ... (Receivers) â† æ¥æ”¶æ¥è‡ª Rank 0

åŒæ—¶è¿›è¡Œï¼Œæ— éœ€ç­‰å¾…ï¼
```

**å¸¦å®½åˆ©ç”¨ç‡**ï¼š

```
åŠåŒå·¥è®¾è®¡ï¼ˆé¡ºåºå‘é€/æ¥æ”¶ï¼‰ï¼š
  - å‘é€é˜¶æ®µï¼š50% å¸¦å®½åˆ©ç”¨ç‡ï¼ˆåªæœ‰å‘é€ï¼‰
  - æ¥æ”¶é˜¶æ®µï¼š50% å¸¦å®½åˆ©ç”¨ç‡ï¼ˆåªæœ‰æ¥æ”¶ï¼‰
  - å¹³å‡ï¼š50%

å…¨åŒå·¥è®¾è®¡ï¼ˆå¹¶è¡Œå‘é€/æ¥æ”¶ï¼‰ï¼š
  - å‘é€ + æ¥æ”¶åŒæ—¶è¿›è¡Œï¼š100% å¸¦å®½åˆ©ç”¨ç‡
  - å®æµ‹ï¼š~153 GB/s (dispatch), ~158 GB/s (combine)
```

---

### 3. å¾ªç¯ç¼“å†²åŒºçš„å¹¶å‘ç®¡ç†

#### å¾ªç¯ç¼“å†²åŒºéœ€è¦åè°ƒ

å¾ªç¯ç¼“å†²åŒºæœ‰ä¸¤ä¸ªå…³é”®æŒ‡é’ˆï¼š

```cpp
int head_idx;  // æ¥æ”¶ç«¯å·²æ¶ˆè´¹çš„ä½ç½®ï¼ˆReceiver æ›´æ–°ï¼‰
int tail_idx;  // å‘é€ç«¯å·²å†™å…¥çš„ä½ç½®ï¼ˆSender æ›´æ–°ï¼‰
```

**é—®é¢˜**ï¼šå¦‚æœåŒä¸€ä¸ª SM æ—¢æ˜¯ sender åˆæ˜¯ receiverï¼š

```
æ—¶åˆ» T0: SM ä½œä¸º Sender
  - æ£€æŸ¥ head_idxï¼ˆéœ€è¦ç¡®ä¿æœ‰ç©ºé—´ï¼‰
  - å†™å…¥æ•°æ®åˆ° slot = tail_idx % capacity
  - æ›´æ–° tail_idx

æ—¶åˆ» T1: SM ä½œä¸º Receiverï¼ˆåŒä¸€ä¸ª SMï¼‰
  - ç­‰å¾… tail_idx æ›´æ–°ï¼ˆéœ€è¦ç¡®ä¿æœ‰æ•°æ®ï¼‰
  - è¯»å–æ•°æ®ä» slot = head_idx % capacity
  - æ›´æ–° head_idx

é—®é¢˜ï¼š
  1. SM åœ¨ T0 å†™å…¥æ•°æ®åï¼Œéœ€è¦åˆ‡æ¢è§’è‰²åˆ° Receiver
  2. ä½†æ­¤æ—¶å…¶ä»– Rank çš„ Sender å¯èƒ½è¿˜åœ¨ç­‰å¾…è¿™ä¸ª SM æ¥æ”¶
  3. å¤æ‚çš„çŠ¶æ€æœºï¼Œå®¹æ˜“æ­»é”
```

**è§£å†³æ–¹æ¡ˆ**ï¼šè§’è‰²åˆ†ç¦»

```
Sender SMsï¼ˆä¸“èŒå‘é€ï¼‰ï¼š
  - æŒç»­æ£€æŸ¥ head_idxï¼ˆvolatile loadï¼‰
  - å†™å…¥æ•°æ®åˆ°å¾ªç¯ç¼“å†²åŒº
  - æ›´æ–° tail_idxï¼ˆrelease è¯­ä¹‰ï¼‰

Receiver SMsï¼ˆä¸“èŒæ¥æ”¶ï¼‰ï¼š
  - æŒç»­è½®è¯¢ tail_idxï¼ˆacquire è¯­ä¹‰ï¼‰
  - è¯»å–æ•°æ®ä»å¾ªç¯ç¼“å†²åŒº
  - æ›´æ–° head_idxï¼ˆrelaxed è¯­ä¹‰ï¼‰

ä¼˜åŠ¿ï¼š
  âœ“ æ¸…æ™°çš„èŒè´£åˆ†ç¦»
  âœ“ æ— çŠ¶æ€åˆ‡æ¢å¼€é”€
  âœ“ ç®€å•çš„åŒæ­¥åè®®
```

---

### 4. æµæ°´çº¿å¹¶è¡Œï¼ˆPipeline Parallelismï¼‰

#### ä¼ ç»Ÿè®¾è®¡ï¼ˆæ— æµæ°´çº¿ï¼‰

```
Time â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º

Rank 0: [Send] â†’ [Wait] â†’ [Recv] â†’ [Wait] â†’ [Send] â†’ ...
Rank 1: [Send] â†’ [Wait] â†’ [Recv] â†’ [Wait] â†’ [Send] â†’ ...

é—®é¢˜ï¼š
  - Send æœŸé—´ï¼ŒRecv SMs ç©ºé—²
  - Recv æœŸé—´ï¼ŒSend SMs ç©ºé—²
  - èµ„æºåˆ©ç”¨ç‡ä½
```

#### DeepEP æµæ°´çº¿è®¾è®¡

```
Time â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º

Rank 0 Senders:   [Send] [Send] [Send] [Send] ...
Rank 0 Receivers: [Recv] [Recv] [Recv] [Recv] ...
                     â†‘       â†‘       â†‘       â†‘
                  åŒæ—¶è¿›è¡Œï¼Œæ— ç­‰å¾…ï¼

ä¼˜åŠ¿ï¼š
  âœ“ å‘é€å’Œæ¥æ”¶æµæ°´çº¿åŒ–
  âœ“ SM èµ„æºå……åˆ†åˆ©ç”¨
  âœ“ æ— ç©ºé—²ç­‰å¾…
```

---

### 5. å¤šé€šé“å¹¶è¡Œï¼ˆMulti-Channel Parallelismï¼‰

#### é€šé“åˆ†é…ç­–ç•¥

```cpp
const auto num_channels = num_sms / 2;  // ä¾‹å¦‚ 24 SMs â†’ 12 channels
const auto responsible_channel = sm_id / 2;

// å¶æ•° SM: Sender for channel (sm_id / 2)
// å¥‡æ•° SM: Receiver for channel (sm_id / 2)
```

**ç¤ºä¾‹**ï¼ˆ24 SMsï¼Œ12 channelsï¼‰ï¼š

```
Channel 0:  SM 0 (Sender)  + SM 1 (Receiver)
Channel 1:  SM 2 (Sender)  + SM 3 (Receiver)
Channel 2:  SM 4 (Sender)  + SM 5 (Receiver)
...
Channel 11: SM 22 (Sender) + SM 23 (Receiver)

æ¯ä¸ª Channel ç‹¬ç«‹è¿è¡Œï¼Œäº’ä¸å¹²æ‰°ï¼
```

**è´Ÿè½½åˆ†é…**ï¼š

```cpp
// Sender è´Ÿè´£çš„ tokens
get_channel_task_range(num_tokens, num_channels, responsible_channel,
                       token_start_idx, token_end_idx);

// ç¤ºä¾‹ï¼š4096 tokens, 12 channels
// Channel 0: tokens [0, 341)
// Channel 1: tokens [341, 682)
// ...
// Channel 11: tokens [3755, 4096)
```

**å¹¶è¡Œåº¦**ï¼š

```
12 channels Ã— 8 ranks = 96 ä¸ªç‹¬ç«‹çš„é€šä¿¡æµ
æ¯ä¸ªæµï¼š
  - 1 ä¸ª Sender SMï¼ˆè´Ÿè´£å‘é€ï¼‰
  - 1 ä¸ª Receiver SMï¼ˆè´Ÿè´£æ¥æ”¶ï¼‰
  - ç‹¬ç«‹çš„å¾ªç¯ç¼“å†²åŒºï¼ˆ256 slotsï¼‰

æ€»å¹¶è¡Œåº¦ï¼š96 ä¸ªå¹¶å‘çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…å¯¹
```

---

### 6. å†…å­˜åºä¸åŒæ­¥ï¼ˆMemory Ordering & Synchronizationï¼‰

#### å‘é€ç«¯çš„å†…å­˜åº

```cpp
// Sender: å†™å…¥æ•°æ®
st_na_global(channel_x_buffers[dst_slot_idx], data);

// Sender: æ›´æ–° tailï¼ˆrelease è¯­ä¹‰ï¼‰
st_release_sys_global(channel_tail_idx.buffer(), cached_channel_tail_idx);
```

**è¯­ä¹‰ä¿è¯**ï¼š
- `st_release_sys_global`ï¼šç¡®ä¿ä¹‹å‰çš„æ‰€æœ‰æ•°æ®å†™å…¥ï¼ˆ`st_na_global`ï¼‰å¯¹æ¥æ”¶ç«¯å¯è§
- **Happens-Before å…³ç³»**ï¼šå†™å…¥æ•°æ® â†’ æ›´æ–° tail â†’ æ¥æ”¶ç«¯çœ‹åˆ° tail æ›´æ–° â†’ æ•°æ®ä¸€å®šå·²å†™å…¥

---

#### æ¥æ”¶ç«¯çš„å†…å­˜åº

```cpp
// Receiver: è½®è¯¢ tailï¼ˆacquire è¯­ä¹‰ï¼‰
cached_channel_tail_idx = ld_acquire_sys_global(channel_tail_idx.buffer());

// Receiver: è¯»å–æ•°æ®
ld_nc_global(channel_x_buffers[token_idx_in_buffer]);
```

**è¯­ä¹‰ä¿è¯**ï¼š
- `ld_acquire_sys_global`ï¼šç¡®ä¿è¯»å–åˆ°æœ€æ–°çš„ tail å€¼
- **Happens-Before å…³ç³»**ï¼šå‘é€ç«¯æ›´æ–° tail â†’ æ¥æ”¶ç«¯è¯»å– tail â†’ æ¥æ”¶ç«¯è¯»å–æ•°æ®ï¼ˆæ•°æ®ä¸€å®šæœ‰æ•ˆï¼‰

---

#### ä¸ºä»€ä¹ˆéœ€è¦è§’è‰²åˆ†ç¦»ï¼Ÿ

å¦‚æœåŒä¸€ä¸ª SM æ—¢å‘é€åˆæ¥æ”¶ï¼Œéœ€è¦å¤„ç†å¤æ‚çš„å†…å­˜åºï¼š

```cpp
// é”™è¯¯ç¤ºä¾‹ï¼šåŒä¸€ä¸ª SM æ—¢å‘é€åˆæ¥æ”¶
__global__ void bad_design() {
    // é˜¶æ®µ 1: ä½œä¸º Sender
    st_release_sys_global(&tail_idx, new_tail);

    // éœ€è¦ fenceï¼Ÿbarrierï¼Ÿ
    __syncthreads();  // ä¸å¤Ÿï¼åªæ˜¯ block å†…åŒæ­¥
    memory_fence();   // å¼€é”€å¤§

    // é˜¶æ®µ 2: ä½œä¸º Receiver
    ld_acquire_sys_global(&tail_idx);

    // é—®é¢˜ï¼šå¦‚ä½•ç¡®ä¿é˜¶æ®µ 1 çš„å†™å…¥å¯¹é˜¶æ®µ 2 å¯è§ï¼Ÿ
    // éœ€è¦å¤æ‚çš„åŒæ­¥ï¼Œæ€§èƒ½å·®
}
```

**åˆ†ç¦»è®¾è®¡çš„ä¼˜åŠ¿**ï¼š

```cpp
// Sender SMï¼ˆä¸“èŒï¼‰
if (is_sender) {
    st_release_sys_global(&tail_idx, new_tail);
    // ä¸éœ€è¦é¢å¤–åŒæ­¥ï¼Œrelease è¯­ä¹‰è¶³å¤Ÿ
}

// Receiver SMï¼ˆä¸“èŒï¼Œä¸åŒçš„ SMï¼‰
else {
    ld_acquire_sys_global(&tail_idx);
    // acquire è¯­ä¹‰ä¿è¯è¯»å–åˆ°æœ€æ–°å€¼
}

// æ¸…æ™°çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…è¯­ä¹‰ï¼Œæ— éœ€å¤æ‚åŒæ­¥
```

---

## è®¾è®¡å¯¹æ¯”

### è®¾è®¡ Aï¼šæ‰€æœ‰ SM éƒ½å‘é€å’Œæ¥æ”¶ï¼ˆé¡ºåºï¼‰

```cpp
__global__ void sequential_design() {
    // é˜¶æ®µ 1: æ‰€æœ‰ SM å‘é€
    for (int i = 0; i < num_tokens; i++) {
        nvshmem_put(...);
    }
    nvshmem_quiet();

    // å…¨å±€åŒæ­¥ï¼ˆæ˜‚è´µï¼ï¼‰
    nvshmem_barrier_all();

    // é˜¶æ®µ 2: æ‰€æœ‰ SM æ¥æ”¶
    for (int i = 0; i < num_recv_tokens; i++) {
        // ä»ç¼“å†²åŒºè¯»å–
    }
}
```

**ç¼ºç‚¹**ï¼š
- âŒ éœ€è¦å…¨å±€ barrierï¼ˆæ˜‚è´µï¼‰
- âŒ å‘é€æœŸé—´ï¼Œæ¥æ”¶èµ„æºç©ºé—²ï¼ˆ50% åˆ©ç”¨ç‡ï¼‰
- âŒ æ¥æ”¶æœŸé—´ï¼Œå‘é€èµ„æºç©ºé—²ï¼ˆ50% åˆ©ç”¨ç‡ï¼‰
- âŒ å¯èƒ½æ­»é”ï¼ˆå¦‚æœç¼“å†²åŒºä¸å¤Ÿå¤§ï¼‰
- âŒ æ€»æ—¶é—´ = T_send + T_barrier + T_recv

---

### è®¾è®¡ Bï¼šDeepEP çš„ Send/Recv åˆ†ç¦»ï¼ˆå¹¶è¡Œï¼‰

```cpp
__global__ void parallel_design() {
    if (is_sender) {
        // Sender SMsï¼šæŒç»­å‘é€
        while (has_tokens) {
            check_queue_capacity();
            write_to_ring_buffer();
            update_tail_idx();
        }
    } else {
        // Receiver SMsï¼šæŒç»­æ¥æ”¶
        while (has_data_to_recv) {
            poll_tail_idx();
            read_from_ring_buffer();
            update_head_idx();
        }
    }
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… æ— éœ€å…¨å±€ barrier
- âœ… å‘é€å’Œæ¥æ”¶å¹¶è¡Œè¿›è¡Œï¼ˆ100% åˆ©ç”¨ç‡ï¼‰
- âœ… æµæ°´çº¿åŒ–ï¼Œæ— ç©ºé—²ç­‰å¾…
- âœ… æ­»é”é¿å…ï¼ˆå§‹ç»ˆæœ‰æ¥æ”¶ç«¯ï¼‰
- âœ… æ€»æ—¶é—´ â‰ˆ max(T_send, T_recv)ï¼ˆé‡å ï¼‰

---

## å¯è§†åŒ–å¯¹æ¯”

### é¡ºåºè®¾è®¡çš„æ—¶é—´çº¿

```
Time â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
     0ms        10ms       15ms       25ms       30ms

Rank 0: [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Send â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]â”€Barrierâ”€[â–ˆâ–ˆâ–ˆâ–ˆ Recv â–ˆâ–ˆâ–ˆâ–ˆ]
Rank 1: [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Send â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]â”€Barrierâ”€[â–ˆâ–ˆâ–ˆâ–ˆ Recv â–ˆâ–ˆâ–ˆâ–ˆ]
Rank 2: [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Send â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]â”€Barrierâ”€[â–ˆâ–ˆâ–ˆâ–ˆ Recv â–ˆâ–ˆâ–ˆâ–ˆ]

æ€»æ—¶é—´ï¼š30ms
èµ„æºåˆ©ç”¨ç‡ï¼š50%ï¼ˆå‘é€å’Œæ¥æ”¶è½®æµï¼Œä¸€åŠæ—¶é—´ç©ºé—²ï¼‰
```

---

### DeepEP å¹¶è¡Œè®¾è®¡çš„æ—¶é—´çº¿

```
Time â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
     0ms                          10ms

Rank 0 Senders:   [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Send â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]
Rank 0 Receivers: [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Recv â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]

Rank 1 Senders:   [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Send â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]
Rank 1 Receivers: [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Recv â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]

Rank 2 Senders:   [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Send â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]
Rank 2 Receivers: [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Recv â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]

æ€»æ—¶é—´ï¼š10msï¼ˆ3x åŠ é€Ÿï¼ï¼‰
èµ„æºåˆ©ç”¨ç‡ï¼š100%ï¼ˆå‘é€å’Œæ¥æ”¶åŒæ—¶è¿›è¡Œï¼‰
```

---

## å®ç°ç»†èŠ‚ï¼šä¸ºä»€ä¹ˆæ˜¯"å¶æ•°å‘é€ï¼Œå¥‡æ•°æ¥æ”¶"ï¼Ÿ

### SM åˆ†é…ç­–ç•¥

```cpp
const auto num_channels = num_sms / 2;       // 12 channels
const auto responsible_channel = sm_id / 2;  // å“ªä¸ª channel
const bool is_sender = sm_id % 2 == 0;       // å¶æ•°=Sender, å¥‡æ•°=Receiver

// ç¤ºä¾‹ï¼š
// SM 0: Channel 0, Sender
// SM 1: Channel 0, Receiver
// SM 2: Channel 1, Sender
// SM 3: Channel 1, Receiver
// ...
```

**ä¸ºä»€ä¹ˆè¿™æ ·åˆ†é…ï¼Ÿ**

1. **ç©ºé—´å±€éƒ¨æ€§**ï¼š
   - åŒä¸€ä¸ª channel çš„ sender å’Œ receiver åœ¨ç›¸é‚»çš„ SM ä¸Š
   - å¯èƒ½å…±äº« L2 cacheï¼ˆå‡å°‘ç¼“å­˜æœªå‘½ä¸­ï¼‰

2. **ç®€å•çš„æ˜ å°„**ï¼š
   - `sm_id / 2` ç›´æ¥å¾—åˆ° channel ID
   - `sm_id % 2` ç›´æ¥å¾—åˆ°è§’è‰²

3. **è´Ÿè½½å‡è¡¡**ï¼š
   - 24 SMs â†’ 12 channelsï¼Œæ¯ä¸ª channel ä¸€å¯¹ sender/receiver
   - å‡åŒ€åˆ†é…ï¼Œæ— éœ€å¤æ‚è°ƒåº¦

---

### å¦‚æœä½¿ç”¨å…¶ä»–åˆ†é…ç­–ç•¥ï¼Ÿ

#### ç­–ç•¥ 1ï¼šå‰ä¸€åŠ SMs å‘é€ï¼Œåä¸€åŠæ¥æ”¶

```cpp
const bool is_sender = sm_id < num_sms / 2;

// SM 0-11: Senders
// SM 12-23: Receivers
```

**ç¼ºç‚¹**ï¼š
- âŒ ç©ºé—´å±€éƒ¨æ€§å·®ï¼ˆsender å’Œ receiver åœ¨ä¸åŒçš„ SM clusterï¼‰
- âŒ å¯èƒ½å¯¼è‡´ L2 cache thrashing

#### ç­–ç•¥ 2ï¼šéšæœºåˆ†é…

**ç¼ºç‚¹**ï¼š
- âŒ ä¸å¯é¢„æµ‹
- âŒ éš¾ä»¥è°ƒè¯•

---

## æ€§èƒ½å½±å“åˆ†æ

### å®æµ‹æ•°æ®ï¼ˆDeepEP Intranodeï¼‰

**é…ç½®**ï¼š
- 4096 tokens
- 7168 hidden
- Top-8 experts
- 8 ranks (NVLink)

**ç»“æœ**ï¼š

| è®¾è®¡ | Dispatch ååé‡ | Combine ååé‡ |
|------|----------------|----------------|
| **Send/Recv åˆ†ç¦»**ï¼ˆå®é™…ï¼‰ | **153 GB/s** | **158 GB/s** |
| é¡ºåºè®¾è®¡ï¼ˆä¼°ç®—ï¼‰ | ~76 GB/s | ~79 GB/s |

**æå‡**ï¼š~2xï¼ˆæ¥è¿‘ç†è®ºçš„å…¨åŒå·¥æå‡ï¼‰

---

### å¸¦å®½åˆ©ç”¨ç‡åˆ†æ

**ç¡¬ä»¶ç“¶é¢ˆ**ï¼š
- H800 NVLink å¸¦å®½ï¼š~900 GB/sï¼ˆåŒå‘ï¼Œç†è®ºå³°å€¼ï¼‰
- å®æµ‹ï¼š~153 GB/s dispatch, ~158 GB/s combine
- åˆ©ç”¨ç‡ï¼š~17%

**ä¸ºä»€ä¹ˆä¸æ˜¯ 100%ï¼Ÿ**

1. **PCIe æ‹“æ‰‘é™åˆ¶**ï¼šä¸æ˜¯æ‰€æœ‰ GPU éƒ½é€šè¿‡ NVLink è¿æ¥
2. **Kernel å¼€é”€**ï¼šå¾ªç¯ç¼“å†²åŒºç®¡ç†ã€è½®è¯¢å¼€é”€
3. **æ•°æ®æ‹·è´**ï¼šå†…å­˜å¸¦å®½ç“¶é¢ˆï¼ˆGPU å†…å­˜ â†’ NVLinkï¼‰
4. **åŒæ­¥å¼€é”€**ï¼š`quiet`, `barrier` ç­‰æ“ä½œ

**ä½†æ˜¯**ï¼šSend/Recv åˆ†ç¦»å·²ç»**æœ€å¤§åŒ–**äº†åœ¨ç»™å®šçº¦æŸä¸‹çš„å¸¦å®½åˆ©ç”¨ç‡ï¼

---

## ç±»æ¯”ï¼šç°å®ä¸–ç•Œçš„ä¾‹å­

### ç±»æ¯” 1ï¼šé«˜é€Ÿå…¬è·¯

**é¡ºåºè®¾è®¡**ï¼ˆå•è½¦é“ï¼‰ï¼š
```
0-10åˆ†é’Ÿ: æ‰€æœ‰è½¦å‘åŒ— â†’
10-15åˆ†é’Ÿ: æ‰€æœ‰è½¦åœä¸‹ï¼Œç­‰å¾…åå‘è½¦
15-25åˆ†é’Ÿ: æ‰€æœ‰è½¦å‘å— â†

é—®é¢˜ï¼šåå‘è½¦åœ¨ 0-10 åˆ†é’Ÿç©ºç­‰ï¼Œæ•ˆç‡ä½
```

**å¹¶è¡Œè®¾è®¡**ï¼ˆåŒè½¦é“ï¼‰ï¼š
```
0-10åˆ†é’Ÿ:
  åŒ—å‘è½¦é“ â†’ æŒç»­å‘åŒ—
  å—å‘è½¦é“ â† æŒç»­å‘å—

ä¼˜åŠ¿ï¼šåŒå‘åŒæ—¶é€šè¡Œï¼Œæ— ç­‰å¾…
```

---

### ç±»æ¯” 2ï¼šç”µè¯é€šä¿¡

**åŠåŒå·¥**ï¼ˆå¯¹è®²æœºï¼‰ï¼š
```
A: "æ”¶åˆ°ï¼Œover"ï¼ˆA è¯´è¯ï¼ŒB ç­‰å¾…ï¼‰
B: "æ˜ç™½ï¼Œover"ï¼ˆB è¯´è¯ï¼ŒA ç­‰å¾…ï¼‰

é—®é¢˜ï¼šåªèƒ½ä¸€æ–¹è¯´è¯ï¼Œè½®æµè¿›è¡Œ
```

**å…¨åŒå·¥**ï¼ˆç”µè¯ï¼‰ï¼š
```
A å’Œ B å¯ä»¥åŒæ—¶è¯´è¯å’Œå¬

ä¼˜åŠ¿ï¼šè‡ªç„¶å¯¹è¯ï¼Œæ— éœ€ç­‰å¾…
```

---

### ç±»æ¯” 3ï¼šå·¥å‚æµæ°´çº¿

**é¡ºåºç”Ÿäº§**ï¼š
```
0-10åˆ†é’Ÿ: æ‰€æœ‰å·¥äººéƒ½åœ¨ç»„è£…
10-15åˆ†é’Ÿ: æ‰€æœ‰å·¥äººåœä¸‹ï¼Œç­‰å¾…è´¨æ£€
15-25åˆ†é’Ÿ: æ‰€æœ‰å·¥äººéƒ½åœ¨è´¨æ£€

é—®é¢˜ï¼šç»„è£…æœŸé—´ï¼Œè´¨æ£€è®¾å¤‡ç©ºé—²
```

**æµæ°´çº¿ç”Ÿäº§**ï¼ˆDeepEP æ¨¡å¼ï¼‰ï¼š
```
0-10åˆ†é’Ÿ:
  å·¥äºº A: æŒç»­ç»„è£…
  å·¥äºº B: æŒç»­è´¨æ£€

ä¼˜åŠ¿ï¼šç»„è£…å’Œè´¨æ£€åŒæ—¶è¿›è¡Œï¼Œè®¾å¤‡å……åˆ†åˆ©ç”¨
```

---

## æ€»ç»“

### ä¸ºä»€ä¹ˆéœ€è¦ Send/Recv åˆ†ç¦»ï¼Ÿ

#### æ ¸å¿ƒåŸå› 

1. **é¿å…æ­»é”**
   - å¦‚æœæ‰€æœ‰ GPU éƒ½å…ˆå‘é€ï¼Œå¾ªç¯ç¼“å†²åŒºä¼šæ»¡
   - éœ€è¦æœ‰æ¥æ”¶ç«¯æŒç»­æ¶ˆè´¹æ•°æ®

2. **å…¨åŒå·¥é€šä¿¡**
   - å‘é€å’Œæ¥æ”¶åŒæ—¶è¿›è¡Œï¼Œå¸¦å®½åˆ©ç”¨ç‡ç¿»å€
   - æ—¶é—´ = max(T_send, T_recv) è€Œé T_send + T_recv

3. **æµæ°´çº¿å¹¶è¡Œ**
   - Sender SMs å’Œ Receiver SMs å½¢æˆæµæ°´çº¿
   - æ— ç©ºé—²ç­‰å¾…ï¼ŒSM èµ„æºå……åˆ†åˆ©ç”¨

4. **ç®€åŒ–åŒæ­¥åè®®**
   - æ¸…æ™°çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…è¯­ä¹‰
   - åŸºäº release/acquire çš„å†…å­˜åºï¼Œæ— éœ€å¤æ‚ fence

5. **å¤šé€šé“å¹¶è¡Œ**
   - 12 channels Ã— 8 ranks = 96 ä¸ªç‹¬ç«‹é€šä¿¡æµ
   - æ¯ä¸ª channel ä¸€å¯¹ sender/receiverï¼Œäº’ä¸å¹²æ‰°

---

### è®¾è®¡ç²¾é«“

```
DeepEP Send/Recv åˆ†ç¦» = GPU ä¸Šçš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼

ç”Ÿäº§è€…ï¼ˆSender SMsï¼‰ï¼š
  - ç”Ÿäº§æ•°æ®åˆ°å¾ªç¯ç¼“å†²åŒº
  - æ›´æ–° tail_idxï¼ˆç”Ÿäº§è¿›åº¦ï¼‰
  - æ£€æŸ¥ head_idxï¼ˆæ¶ˆè´¹è¿›åº¦ï¼Œæµæ§ï¼‰

æ¶ˆè´¹è€…ï¼ˆReceiver SMsï¼‰ï¼š
  - ä»å¾ªç¯ç¼“å†²åŒºæ¶ˆè´¹æ•°æ®
  - æ›´æ–° head_idxï¼ˆæ¶ˆè´¹è¿›åº¦ï¼‰
  - è½®è¯¢ tail_idxï¼ˆç”Ÿäº§è¿›åº¦ï¼Œç­‰å¾…æ–°æ•°æ®ï¼‰

åŒæ­¥æœºåˆ¶ï¼š
  - tail_idx: ç”Ÿäº§è€…å†™ï¼ˆreleaseï¼‰ï¼Œæ¶ˆè´¹è€…è¯»ï¼ˆacquireï¼‰
  - head_idx: æ¶ˆè´¹è€…å†™ï¼ˆrelaxedï¼‰ï¼Œç”Ÿäº§è€…è¯»ï¼ˆvolatileï¼‰
  - æ— éœ€å…¨å±€ barrierï¼Œé«˜æ•ˆä¸”æ— æ­»é”
```

---

### å…³é”®æ´å¯Ÿ

1. **è§’è‰²åˆ†ç¦» â‰  æµªè´¹èµ„æº**
   - çœ‹ä¼¼ä¸€åŠ SM å‘é€ï¼Œä¸€åŠæ¥æ”¶ï¼ˆ50% åˆ©ç”¨ç‡ï¼Ÿï¼‰
   - å®é™…ï¼šå‘é€å’Œæ¥æ”¶åŒæ—¶è¿›è¡Œï¼ˆ100% åˆ©ç”¨ç‡ï¼ï¼‰

2. **å±€éƒ¨é¡ºåºï¼Œå…¨å±€å¹¶è¡Œ**
   - å•ä¸ª channelï¼šsender â†’ buffer â†’ receiverï¼ˆé¡ºåºï¼‰
   - å¤šä¸ª channelsï¼š12 ä¸ª channels åŒæ—¶è¿è¡Œï¼ˆå¹¶è¡Œï¼‰

3. **ç¡¬ä»¶å‹å¥½çš„è®¾è®¡**
   - åˆ©ç”¨ NVLink çš„åŒå‘å¸¦å®½
   - ç¬¦åˆ release/acquire å†…å­˜æ¨¡å‹
   - æœ€å°åŒ–åŒæ­¥å¼€é”€

---

### å¦‚æœåªç”¨ä¸€ä¸ªè§’è‰²ä¼šæ€æ ·ï¼Ÿ

| è®¾è®¡ | ä¼˜ç‚¹ | ç¼ºç‚¹ | ç»“æœ |
|------|------|------|------|
| **æ‰€æœ‰ SM éƒ½å‘é€å’Œæ¥æ”¶** | ç®€å• | âŒ éœ€è¦å…¨å±€ barrier<br/>âŒ å¯èƒ½æ­»é”<br/>âŒ èµ„æºåˆ©ç”¨ç‡ä½ | æ€§èƒ½å·® |
| **Send/Recv åˆ†ç¦»**ï¼ˆDeepEPï¼‰ | âœ… æ— æ­»é”<br/>âœ… å…¨åŒå·¥<br/>âœ… æµæ°´çº¿<br/>âœ… é«˜åˆ©ç”¨ç‡ | ç¨å¾®å¤æ‚ | **æ€§èƒ½ä¼˜ç§€** |

---

## ç»“è®º

**Send å’Œ Recv åˆ†ç¦»ä¸æ˜¯å¤šä½™çš„å¤æ‚æ€§ï¼Œè€Œæ˜¯é«˜æ€§èƒ½ GPU é€šä¿¡çš„å¿…è¦è®¾è®¡ã€‚**

å®ƒå®ç°äº†ï¼š
- âœ… **æ— æ­»é”**çš„åˆ†å¸ƒå¼é€šä¿¡
- âœ… **å…¨åŒå·¥**çš„å¸¦å®½åˆ©ç”¨
- âœ… **æµæ°´çº¿**çš„å¹¶è¡Œæ‰§è¡Œ
- âœ… **ç®€æ´**çš„åŒæ­¥åè®®

è¿™å°±æ˜¯ DeepEP èƒ½è¾¾åˆ° **153 GB/s** ååé‡çš„æ ¸å¿ƒç§˜å¯†ä¹‹ä¸€ï¼ğŸš€

---

## é™„å½•ï¼šå®Œæ•´æ•°æ®æµå›¾

```
                   Rank 0                                    Rank 1
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                 â”‚    â”‚                                 â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚ Sender   â”‚â”€â”€â”€â–¶â”‚ å¾ªç¯ç¼“å†²åŒº â”‚â”€â”¼â”€â”€â”€â”€â”¼â–¶â”‚ å¾ªç¯ç¼“å†²åŒº â”‚â—€â”€â”€â”€â”‚ Sender   â”‚  â”‚
    â”‚  â”‚ SMs      â”‚    â”‚(Rank 1 ä¾§)â”‚ â”‚    â”‚ â”‚(Rank 0 ä¾§)â”‚    â”‚ SMs      â”‚  â”‚
    â”‚  â”‚(0,2,4..) â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚(0,2,4..) â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â–²       â”‚    â”‚       â–²          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                         â”‚       â”‚    â”‚       â”‚                        â”‚
    â”‚                         â”‚       â”‚    â”‚       â”‚                        â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚       â”‚    â”‚       â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚ Receiver â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚    â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Receiver â”‚  â”‚
    â”‚  â”‚ SMs      â”‚                   â”‚    â”‚                  â”‚ SMs      â”‚  â”‚
    â”‚  â”‚(1,3,5..) â”‚                   â”‚    â”‚                  â”‚(1,3,5..) â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚    â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚         â”‚                       â”‚    â”‚                       â”‚        â”‚
    â”‚         â–¼                       â”‚    â”‚                       â–¼        â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚    â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚ Final    â”‚                  â”‚    â”‚                  â”‚ Final    â”‚  â”‚
    â”‚  â”‚ Buffer   â”‚                  â”‚    â”‚                  â”‚ Buffer   â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚    â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                 â”‚    â”‚                                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    å‘é€æ•°æ®æµï¼šRank 0 Sender â†’ Rank 1 å¾ªç¯ç¼“å†²åŒº â†’ Rank 1 Receiver â†’ Rank 1 Final Buffer
    æ¥æ”¶æ•°æ®æµï¼šRank 1 Sender â†’ Rank 0 å¾ªç¯ç¼“å†²åŒº â†’ Rank 0 Receiver â†’ Rank 0 Final Buffer

    åŒæ—¶è¿›è¡Œï¼Œå…¨åŒå·¥é€šä¿¡ï¼
```

è¿™å°±æ˜¯ DeepEP Send/Recv åˆ†ç¦»è®¾è®¡çš„å®Œæ•´è§£æï¼
